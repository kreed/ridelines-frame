name: Deploy to Development

on:
  push:
    branches: [main]
    paths: ['versions.yml', 'environments/dev/**', 'modules/**']
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  packages: read

jobs:
  deploy-dev:
    name: Deploy to Development Environment
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Download packages
        run: ./scripts/download-packages.sh development

      - name: Set package versions for summary
        run: |
          HUB_VERSION=$(yq eval '.development.hub.version' versions.yml)
          LAMBDA_VERSION=$(yq eval '.development.drivetrain.lambda.version' versions.yml)
          LAYER_VERSION=$(yq eval '.development.drivetrain.tippecanoe_layer.version' versions.yml)
          
          echo "HUB_VERSION=${HUB_VERSION}" >> $GITHUB_ENV
          echo "LAMBDA_VERSION=${LAMBDA_VERSION}" >> $GITHUB_ENV
          echo "LAYER_VERSION=${LAYER_VERSION}" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: ${{ github.run_id }}

      - name: Apply infrastructure changes
        uses: dflook/tofu-apply@v2
        with:
          path: environments/dev
          auto_approve: true
          var_file: |
            environments/dev/terraform.tfvars

      - name: Get website bucket name
        id: website_bucket
        uses: dflook/tofu-output@v1
        with:
          path: environments/dev
          output: website_bucket_name

      - name: Deploy hub to S3
        run: |
          aws s3 sync artifacts/hub/static-site/ s3://${{ steps.website_bucket.outputs.value }}/ --delete

      - name: Deployment summary
        run: |
          echo "## Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "📦 Packages deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- Hub: ${HUB_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- Drivetrain Lambda: ${LAMBDA_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- Tippecanoe Layer: ${LAYER_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "🌐 Environment: Development" >> $GITHUB_STEP_SUMMARY
          echo "🚀 Deployed from commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY